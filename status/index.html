<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hack-Wanderer Status</title>
  <style>
    :root {
      --bg: #0f172a;
      --card: #111827;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #22d3ee;
      --warn: #fbbf24;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      padding: 6px;
      font-family: "Segoe UI", sans-serif;
      background: radial-gradient(circle at 20% 20%, #1f2937 0%, #0f172a 45%);
      color: var(--text);
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      touch-action: pan-y;
    }
    h1 { margin: 0 0 4px; font-size: 13px; letter-spacing: 0.3px; display: flex; align-items: center; gap: 8px; }
    .panel {
      background: var(--card);
      border: 1px solid #1f2937;
      border-radius: 6px;
      padding: 6px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
    }
    .line { font-size: 11px; margin: 0 0 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .lights { display: flex; gap: 8px; align-items: center; }
    .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #374151;
      border: 1px solid #111;
      box-shadow: 0 0 6px rgba(0,0,0,0.4);
    }
    .on { background: #22c55e; box-shadow: 0 0 10px rgba(34,197,94,0.9); animation: pulse 1.4s infinite; }
    .warn { background: #fbbf24; box-shadow: 0 0 10px rgba(251,191,36,0.9); }
    .off { background: #ef4444; box-shadow: 0 0 10px rgba(239,68,68,0.9); }
    .icon { font-size: 9px; color: var(--muted); }
    @keyframes pulse {
      0% { transform: scale(0.9); }
      50% { transform: scale(1.05); }
      100% { transform: scale(0.9); }
    }
    table { width: 100%; border-collapse: collapse; margin-top: 4px; }
    th, td { font-size: 11px; padding: 3px 2px; text-align: left; }
    th { color: var(--muted); border-bottom: 1px solid #1f2937; }
    tr:nth-child(every) { background: transparent; }
  </style>
</head>
<body>
  <h1>
    Hack-Wanderer
    <span class="lights">
      <span class="icon">LTE</span><span class="dot" id="light-lte" title="LTE"></span>
      <span class="icon">GPSd</span><span class="dot" id="light-gpsdev" title="GPS device"></span>
      <span class="icon">GPSm</span><span class="dot" id="light-gpsmodem" title="GPS modem"></span>
      <span class="icon">SIM</span><span class="dot" id="light-sim" title="SIM"></span>
    </span>
  </h1>
  <div class="panel" id="panel">
    <div id="l1" class="line">--</div>
    <div id="l2" class="line">--</div>
    <div id="l3" class="line">--</div>
    <div id="l4" class="line">--</div>
    <div id="l5" class="line">--</div>
    <table id="towers-table">
      <thead>
        <tr><th>RAT</th><th>Cell</th><th>Lat/Lon</th><th>Time</th></tr>
      </thead>
      <tbody id="towers-body">
        <tr><td colspan="4">--</td></tr>
      </tbody>
    </table>
  </div>
  <script>
    async function loadStatus() {
      try {
        const res = await fetch('./status.json', {cache: 'no-store'});
        if (!res.ok) throw new Error(res.statusText);
        const data = await res.json();
        render(data);
      } catch (err) {
        document.getElementById('updated').textContent = 'Error loading status';
      }
    }

    function render(data) {
      const updated = data.timestamp_utc || '--';
      const timeShort = updated && updated.indexOf('T') >= 0 ? updated.split('T')[1].replace('Z','') : (updated || '--');
      const towers = data.towers || [];
      const loc = data.location || {};
      const locText = (loc.lat != null && loc.lon != null) ?
        `${loc.lat.toFixed(5)},${loc.lon.toFixed(5)}${loc.alt_m != null ? ' ' + loc.alt_m + 'm' : ''}` : 'No fix';
      const locShort = (loc.lat != null && loc.lon != null) ? `${loc.lat.toFixed(4)},${loc.lon.toFixed(4)}` : '--';
      const gpsDevice = data.gps_device || {};
      const gpsDeviceLoc = (gpsDevice.location || {});
      const gpsDeviceText = (gpsDeviceLoc.lat != null && gpsDeviceLoc.lon != null)
        ? `${gpsDeviceLoc.lat.toFixed(5)},${gpsDeviceLoc.lon.toFixed(5)} s${((gpsDevice.satellites||{}).in_use)||'?'}/${((gpsDevice.satellites||{}).in_view)||'?'}` 
      : 'No fix';
      const gpsModem = data.gps_lte_modem || {};
      const gpsModemInfo = gpsModem.cgnsinf || {};
      const gpsModemText = (gpsModemInfo.lat != null && gpsModemInfo.lon != null)
        ? `${Number(gpsModemInfo.lat).toFixed(5)},${Number(gpsModemInfo.lon).toFixed(5)} f${gpsModemInfo.fix_status||'?'}` 
        : 'No fix';

      const net = data.network || {};
      const cops = net.cops_current || {};
      const reg = (net.cereg && net.cereg.stat_text) ? net.cereg : (net.cgreg && net.cgreg.stat_text ? net.cgreg : net.creg || {});
      const signal = net.csq || {};

      const l1 = `T:${timeShort} Loc:${locText}`;
      const l2 = `GPSd:${gpsDeviceText} | GPSm:${gpsModemText}`;
      const l3 = `Net:${cops.operator||'unk'} act:${cops.act!=null?cops.act:'?'} reg:${reg.stat_text||'?'} | Sig:${signal.rssi_dbm!=null?signal.rssi_dbm+'dBm':'?' } r:${signal.rssi??'?' } SIM:${data.sim_status||'?'}`;
      const l4 = '';
      const l5 = `Tw:${towers.length||0}`;

      const reversed = towers.slice().reverse(); // latest first if appended
      const tbody = document.getElementById('towers-body');
      tbody.innerHTML = '';
      if (!reversed.length) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="4">No towers</td>';
        tbody.appendChild(tr);
      } else {
        reversed.forEach(t => {
          const tr = document.createElement('tr');
          const rat = t.rat || t.mode || '?';
          const id = t.cell_id != null ? t.cell_id : 'unk';
          tr.innerHTML = `<td>${rat}</td><td>${id}</td><td>${locShort}</td><td>${timeShort}</td>`;
          tbody.appendChild(tr);
        });
      }

      document.getElementById('l1').textContent = l1;
      document.getElementById('l2').textContent = l2;
      document.getElementById('l3').textContent = l3;
      document.getElementById('l4').textContent = l4;
      document.getElementById('l5').textContent = l5;

      // lights
      const light = (id, state) => {
        const el = document.getElementById(id);
        el.classList.remove('on','warn','off');
        el.classList.add(state ? 'on' : 'off');
      };
      light('light-sim', (data.sim_status||'').toUpperCase() === 'READY');
      const regOk = (reg.stat_text||'').toLowerCase().includes('registered');
      light('light-lte', regOk);
      const gpsDevFix = gpsDeviceLoc.lat != null && gpsDeviceLoc.lon != null;
      light('light-gpsdev', gpsDevFix);
      const gpsModFix = gpsModemInfo.lat != null && gpsModemInfo.lon != null;
      light('light-gpsmodem', gpsModFix);
    }

    loadStatus();
    setInterval(loadStatus, 3000);
  </script>
</body>
</html>
